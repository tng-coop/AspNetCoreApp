@page "/editor"
@rendermode InteractiveServer

@using Microsoft.JSInterop
@inject IJSRuntime JS

<h3>Quill Editor Test (v2.0.3) with Table Support (Debug)</h3>

<div class="form-group">
    <label for="editor">Content</label>
    <div id="editor" style="height:200px; background-color:white;"></div>
</div>

<button class="btn btn-primary" @onclick="ShowContentSize">
    Show Content Size
</button>

@if (contentSize >= 0)
{
    <div class="mt-2">
        <strong>Content length:</strong> @contentSize characters
    </div>
}

@code {
    private int contentSize = -1;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        var loader = @"
(function() {
  var head = document.head;
  function loadCSS(href) {
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = href;
    head.appendChild(link);
  }
  function loadScript(src) {
    return new Promise(function(resolve, reject) {
      var s = document.createElement('script');
      s.src = src;
      s.onload = resolve;
      s.onerror = reject;
      head.appendChild(s);
    });
  }

  console.log('Loading Quill + table‐better assets…');
  // Quill Snow theme
  loadCSS('https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css');
  // Table plugin CSS
  loadCSS('https://cdn.jsdelivr.net/npm/quill-table-better@1.0.7/dist/quill-table-better.css');

  // Load Quill core, then plugin
  return loadScript('https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.min.js')
    .then(function() {
      console.log('Quill loaded:', !!window.Quill);
      return loadScript('https://cdn.jsdelivr.net/npm/quill-table-better@1.0.7/dist/quill-table-better.js');
    })
    .then(function() {
      console.log('quill-table-better loaded:', !!window.QuillTableBetter);
    });
})()
.then(function() {
  // Register plugin
  Quill.register({ 'modules/table-better': QuillTableBetter }, true);
  console.log('Registered table-better module.');

  // Initialize editor
  window.quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
      table: false,  // disable core table
      'table-better': {
        language: 'en_US',
        toolbarTable: true, // enable plugin toolbar dropdown
        menus: ['table', 'row', 'column', 'cell', 'merge', 'delete', 'copy']
      },
      keyboard: {
        bindings: QuillTableBetter.keyboardBindings
      },
      toolbar: {
        container: [
          [{ header: [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          ['blockquote', 'code-block'],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['link', 'image', 'video'],
          ['table-better'],  // table icon
          ['clean']
        ],
        handlers: {
          // manual insert so you can see it working
          'table-better': function() {
            console.log('table-better button clicked');
            this.quill.getModule('table-better').insertTable(3, 3);
          }
        }
      }
    },
    placeholder: 'Type here...'
  });

  console.log('Editor initialized. Table module:', window.quill.getModule('table-better'));
})
.catch(function(err) {
  console.error('Failed to load Quill or plugin:', err);
});
";
        await JS.InvokeVoidAsync("eval", loader);
    }

    private async Task ShowContentSize()
    {
        contentSize = await JS.InvokeAsync<int>("eval", "window.quill.getText().trim().length");
        StateHasChanged();
    }
}

@page "/_cms/{CategorySlug}/{Slug}"
@page "/{Tenant}/_cms/{CategorySlug}/{Slug}"
@page "/publications/{Id:guid}"
@using BlazorWebApp.Models
@using BlazorWebApp.Services
@using BlazorWebApp.Utils
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization

@inject IPublicationService PublicationService
@inject ICategoryService CategoryService

@if (pub == null)
{
    <p><em>Publication not found.</em></p>
}
else
{
    <h1>@pub.Title</h1>

    @if (!string.IsNullOrEmpty(fullCategoryPath))
    {
        <p class="text-muted mb-4">
            <small>Category: @fullCategoryPath</small>
        </p>
    }

    <!-- direct HTML render, styled by TinyMCE's content CSS -->
    <p>MCE03</p>
    <div class="mce-content-body">
        @((MarkupString)pub.Html)
    </div>

    <p><small>Created: @pub.CreatedAt:f</small></p>

    @if (pub.PublishedAt.HasValue)
    {
        <p><small>Published: @pub.PublishedAt.Value:f</small></p>
    }

    <AuthorizeView Roles="Admin">
        <div class="mt-3">
            <button class="btn btn-secondary" @onclick="SetAsDraft">
                Set as Draft
            </button>
        </div>
    </AuthorizeView>

    <div class="mt-4">
        <NavLink href="@CmsRoutes.Combine(pub?.CategorySlug)" Match="NavLinkMatch.Prefix">
            Back to @pub?.CategoryName
        </NavLink>
    </div>
}

@code {
    [Parameter] public Guid? Id { get; set; }
    [Parameter] public string CategorySlug { get; set; } = string.Empty;
    [Parameter] public string Slug { get; set; } = string.Empty;
    [Parameter] public string? Tenant { get; set; }

    private PublicationReadDto? pub;
    private string fullCategoryPath = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        if (Id.HasValue)
        {
            pub = await PublicationService.GetAsync(Id.Value);
        }
        else if (!string.IsNullOrEmpty(Slug))
        {
            pub = await PublicationService.GetBySlugAsync(Slug);
        }
        else
        {
            pub = null;
        }

        if (pub?.CategoryId != null)
        {
            var ancestry = await CategoryService.GetAncestryAsync(pub.CategoryId.Value);
            var crumbs = ancestry
                          .Select(c => c.Name)
                          .Append(pub.CategoryName!)
                          .ToList();
            fullCategoryPath = string.Join(" > ", crumbs);
        }
    }

    private async Task SetAsDraft()
    {
        if (pub == null) return;

        await PublicationService.UnpublishAsync(pub.Id);
        pub = await PublicationService.GetAsync(pub.Id);
        StateHasChanged();
    }
}

@page "/notes"
@rendermode InteractiveServer 
@using BlazorWebApp.Data
@using BlazorWebApp.Models
@using BlazorWebApp.Services

@inject INoteService       NoteService
@inject NavigationManager  Nav
@inject ILogger<PublicNotes> Logger

<h1>Public Notes</h1>

<EditForm Model="_newNote"
          OnValidSubmit="Create"
          FormName="PublicNotesForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Title</label>
        <!-- plain <input> with @bind -->
        <input class="form-control"
               @bind="_newNote.Title"
               @bind:event="oninput" />
        <ValidationMessage For="@(() => _newNote.Title)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Content</label>
        <!-- plain <textarea> with @bind -->
        <textarea class="form-control"
                  rows="5"
                  @bind="_newNote.Content"
                  @bind:event="oninput">
        </textarea>
        <ValidationMessage For="@(() => _newNote.Content)" />
    </div>

    <div class="form-check mb-3">
        <input type="checkbox"
               class="form-check-input"
               @bind="_newNote.IsPublic" />
        <label class="form-check-label">Public?</label>
    </div>

    <button type="submit" class="btn btn-primary">Share</button>
</EditForm>

<hr />

@if (_notes is null)
{
    <p><em>Loadingâ€¦</em></p>
}
else if (!_notes.Any())
{
    <p><em>No public notes yet.</em></p>
}
else
{
    <ul class="list-unstyled">
    @foreach (var note in _notes)
    {
        <li class="mb-2">
            <strong>@note.Title</strong><br />
            <small class="text-muted">
              @note.CreatedAt.ToLocalTime().ToString("g")
            </small>
            <p>@note.Content</p>
        </li>
    }
    </ul>
}

@code {
    private List<Note>?   _notes;
    private NoteWriteDto  _newNote = new();

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("Loading notes");
        _notes = await NoteService.GetPublicNotesAsync();
        Logger.LogInformation("Loaded {Count} notes", _notes.Count);
    }

    private async Task Create()
    {
        Logger.LogInformation("Create() called with Title='{Title}', ContentLen={Len}",
                              _newNote.Title, _newNote.Content?.Length);

        var id = await NoteService.CreateNoteAsync(
            _newNote.Title,
            _newNote.Content!,
            _newNote.IsPublic,
            ownerId: null
        );

        Logger.LogInformation("Saved new note {Id}", id);

        _notes   = await NoteService.GetPublicNotesAsync();
        _newNote = new();
    }
}
